name: CI-CD

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      deploy:
        description: "수동 실행 시 CD까지 진행(true/false)"
        required: false
        default: "true"
      simulate_cd_fail:
        description: "CD 단계에서 강제 실패 재연(true/false)"
        required: false
        default: "false"

concurrency:
  group: githubactionPractice-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Gradle permission
        run: chmod +x ./gradlew

      - name: Test
        run: ./gradlew test

      - name: Build bootJar
        run: ./gradlew clean bootJar -x test

      - name: Upload artifact (jar)
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar

  cd:
    needs: ci
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
      || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main' && (github.event.inputs.deploy || 'true') == 'true')

    steps:
      - name: Show target info (masked)
        run: |
          echo "SSH_HOST is set? -> $([[ -n '${{ secrets.SSH_HOST }}' ]] && echo YES || echo NO)"
          echo "SSH_PORT=${{ secrets.SSH_PORT }}"
          echo "SSH_USER=${{ secrets.SSH_USER }}"
          echo "PRIVATE_KEY length=${#SSH_PRIVATE_KEY}"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install tools (ssh, scp, nc, dig)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openssh-client netcat-openbsd dnsutils

      - name: DNS / IP check
        run: |
          echo "dig +short ${{ secrets.SSH_HOST }} || true"
          dig +short "${{ secrets.SSH_HOST }}" || true

      - name: TCP connectivity check (most important)
        run: |
          echo "Checking TCP to ${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT }}"
          nc -vz -w 5 "${{ secrets.SSH_HOST }}" "${{ secrets.SSH_PORT }}" || true

          echo "Also /dev/tcp check"
          timeout 5 bash -lc "cat < /dev/null > /dev/tcp/${{ secrets.SSH_HOST }}/${{ secrets.SSH_PORT }}" \
            && echo "TCP OK" || echo "TCP FAIL"

      - name: Prepare SSH key + known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # private key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # known_hosts: secret 있으면 그걸 쓰고, 없으면 keyscan으로 만든다
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -p "${{ secrets.SSH_PORT }}" -T 5 "${{ secrets.SSH_HOST }}" > ~/.ssh/known_hosts
          fi
          chmod 600 ~/.ssh/known_hosts

          echo "known_hosts line count:"
          wc -l ~/.ssh/known_hosts || true

      - name: SSH handshake debug (vvv)
        run: |
          set -x
          ssh -vvv -i ~/.ssh/deploy_key \
            -p "${{ secrets.SSH_PORT }}" \
            -o StrictHostKeyChecking=yes \
            -o ConnectTimeout=5 \
            -o ServerAliveInterval=5 \
            -o ServerAliveCountMax=2 \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            "echo 'SSH OK'; whoami; hostname; pwd" || true

      - name: Download artifact (jar)
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: dist

      - name: Pick jar as app.jar
        run: |
          ls -al dist
          JAR_PATH="$(ls -1 dist/*.jar | head -n 1)"
          echo "Picked: ${JAR_PATH}"
          cp "${JAR_PATH}" dist/app.jar
          ls -al dist/app.jar

      - name: SCP jar to server (/opt/githubactionPractice/incoming/app.jar) with verbose
        run: |
          set -x
          scp -vvv -i ~/.ssh/deploy_key \
            -P "${{ secrets.SSH_PORT }}" \
            -o StrictHostKeyChecking=yes \
            -o ConnectTimeout=10 \
            dist/app.jar \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/githubactionPractice/incoming/app.jar"

      - name: Remote deploy (debug + optional failure)
        run: |
          set -euo pipefail

          if [ "${{ github.event.inputs.simulate_cd_fail || 'false' }}" = "true" ]; then
            echo "simulate_cd_fail=true -> forcing failure"
            exit 1
          fi

          ssh -vvv -i ~/.ssh/deploy_key \
            -p "${{ secrets.SSH_PORT }}" \
            -o StrictHostKeyChecking=yes \
            -o ConnectTimeout=10 \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            "set -euo pipefail
             echo 'incoming listing:'; ls -al /opt/githubactionPractice/incoming
             echo 'deploy script perms:'; ls -l /usr/local/bin/deploy_githubactionPractice.sh || true
             echo 'run deploy:'; /usr/local/bin/deploy_githubactionPractice.sh
             echo 'service status:'; sudo systemctl status githubactionPractice --no-pager -l || true
             echo 'last logs:'; sudo journalctl -u githubactionPractice -n 80 --no-pager || true"
